<% if Rails.env.development? %>

  class SharkTest {

    constructor() {
      this.its = [];
      this.subtests = {};
    }

  }

  class SharkTestAction {

    constructor(description, method) {
      this.description = description;
      this.method = method;
      this.results = [];
      this.is_async = false;
      this.done = false;
    }

    log(msg) {
      this.results.push(msg);
      return this;
    }    

    async() {
      this.is_async = true;
      return this.log("asynchronous");
    }

  }

  class SharkMethodWrapper {

    constructor(test_action,method) {
      this.test_action = test_action;
      this.method = method;
    }

    log(msg) {
      this.test_action.log(msg);
    }

    async() {
      this.test_action.async();
    }

  }

  class Shark {

    constructor() {
      let shark = this;
      shark.test = new SharkTest();
      shark.current = shark.test;
    }

    run() {
      let shark = this;
      shark.current = shark.test;
      shark.run_aux(shark.current);
    }

    run_aux(test) {

      let shark = this;    

      test.its.forEach(it => {
        if ( it.method ) {  
          try {
            let shark_method_wrapper = new SharkMethodWrapper(it, it.method);
            shark_method_wrapper.method(shark.make_done_doer(it));
            it.log("visited");
          } catch(e) {
            it.log("failed")
              .log(e);
            shark.show_error(it, e)
          }
        } else {
          it.log("unimplemented")
        }
      });

      for ( var test_name in test.subtests ) {
        shark.run_aux(test.subtests[test_name])
      }

    }

    make_done_doer(it) {
      let shark = this;
      return function(err) {
        if ( err ) {
          shark.show_error(it, err.stack)
          it.log('failed asynchronously')
            .log(err)
            .log(err.stack);
        } else {
          it.log("finished asynchronously");
        }
        it.done = true;
        AQ.update();
      }
    }

    show_error(it,e) {
      console.log("%cError: ", "color: red", it.description, e);
    }

  }

  shark = new Shark();

  function describe(test_name, method) {
    let temp = shark.current;
    shark.current.subtests[test_name] = new SharkTest();
    shark.current = shark.current.subtests[test_name];
    method();
    shark.current = temp;
  }

  function it(description, method) {
    let it = new SharkTestAction(description, method);
    shark.current.its.push(it);
    return it;
  }

<% end %>