<script type="text/ng-template" id="operation">
  <ul class='operation-details'>
    <li>Job: <a href="/krill/log?job={{operation.job.id}}">{{operation.job.id}}</a>, last updated {{operation.job.updated_at|date}}</li>
    <li>Submitted by: {{user.find(operation.job.submitted_by).login}}</li>
    <li>Run by: {{user.find(operation.job.user_id).login}}</li>
  </ul>
</script>

<script type="text/ng-template" id="plan">

  <label class="checkbox" ng-if="p.operations.length > 1">
    <input type=checkbox ng-model="node.selected" ng-change="select_predecessor(current_plan,node,p.operations)"></input>
    <b>{{node.operation_type.name}}</b> <span>{{node.status}}</span>
  </label>

  <span ng-if="!(p.operations.length > 1)">

    <span ng-if="!node.open && ( node.status == 'done' || node.status == 'error' )" ng-click="expand(node)" class='clickable'>
      &#9654;
    </span>

    <span ng-if="node.open" ng-click="unexpand(node)" class='clickable'>
      &#9660;
    </span>

    <b>{{node.operation_type.name}}</b> <span>{{node.status}}</span>

  </span>

  <div ng-if="node.open" ng-include="'operation'" ng-init="operation = node"></div>

  <ul ng-if="node.predecessors.length > 0">

    <li ng-repeat="p in node.predecessors">

      {{p.name}}. 

      <span ng-repeat="i in node.inputs | filter: { id: p.id }">

        {{i.child_sample.name}} : 
        {{input_info(i,operation_type(node)).object_type.name}}

        <span ng-if="i.child_item_id && current_plan.status != 'Running'" class="available">
          ... available
        </span>
        <span ng-if="!i.child_item_id && p.operations.length == 0  && current_plan.status != 'Running'" class="problem">
          ... no plan!
        </span>        

        <span ng-if="current_plan.status == 'Running' && ( node.status != 'done' && node.status != 'error'"
              ng-repeat="op in p.operations | filter: { status: 'done' }">
          <span ng-repeat="output in op.outputs | filter: { name: input.name }">
            <a href="/items/{{output.child_item_id}}">{{output.child_item_id}}</a>
            at {{output.child_item.location}}
          </span>
        </span>

        <span ng-if="node.status == 'done'">
          <a href="/items/{{i.child_item.id}}">{{i.child_item.id}}</a>
          at {{i.child_item.location}}          
        </span>

      </span>

      <ul ng-if="p.operations.length > 0">
        <li ng-repeat="node in p.operations" ng-include="'plan'"></li>
      </ul>

    </li>

  </ul>

</script>

<div ng-if="mode=='view'" ng-controller="viewEditPlanCtrl" class='plan'>

  <div class='row-fluid'>

    <div class='span6'>
      <h4>Status: {{current_plan.status}}</h4>
    </div>

    <div ng-if="current_plan.status == 'Under Construction'" class='span6'> 
      <button class="btn btn-small pull-right space" ng-click="delete_plan(current_plan)">Delete</button>
      <button class="btn btn-small btn-success pull-right space" ng-click="launch(current_plan)">Start</button>
    </div>

    <div ng-if="current_plan.status == 'Running'" class='span6'> 
      <button class="btn btn-small btn-warning pull-right space" ng-click="stop_plan(current_plan)">Stop</button>
    </div>

  </div>

  <div class="alert" ng-if="current_plan.issues && current_plan.issues.length > 0">
    <div ng-repeat="issue in current_plan.issues">
      {{issue.msg}}
    </div>
  </div>  

  <div ng-repeat="node in current_plan.goals">

    <div ng-repeat="output in node.outputs">

        {{output.name}}. {{output.child_sample.name}} : 
        {{output_info(output,operation_type(node)).object_type.name}}
        <span ng-if="node.status == 'done'">
          <a href="/items/{{output.child_item.id}}">{{output.child_item.id}}</a>
          at {{output.child_item.location}}
        </span>

    </div>

    <ul>
      <li ng-include="'plan'"></li>
    </ul>

  </div>

  <!-- pre>{{current_plan|json}}</pre -->

</div>
