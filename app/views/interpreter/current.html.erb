<% provide(:title, @path) %>

<div class="row-fluid interpreter-container" id="interpreter">

  <!-- FLOW CHART ----------------------------------------------------->
  <div class="span1 interpreter-flow-chart">

     <p>HISTORY</p>
     <p class='small'>(Not yet implemented)</p>
     <p class='small'>pc:<%= @pc %></p>

  </div>

  <!-- MAIN ----------------------------------------------------------->
  <div class="span9 interpreter-main">
    <% if @exception %>
       <%= render 'error' %>
    <% elsif @pc != Job.COMPLETED %>
      <%= render @instruction.name %>
      <div id='note' style='display: none'>
        <hr />
        <p>Add a note to the log for this step</p>
        <textarea rows="3" id='note-textarea'></textarea>
      </div>
    <% else %>
      <div class="alert alert-info">THIS JOB IS NO LONGER ACTIVE</div>
      <p><%= link_to 'View Log for Job ' + @job.id.to_s, @job %></p>
    <% end %>
  </div>

  <!-- BUTTONS -------------------------------------------------------->
  <div class="span2 interpreter-buttons">
    <% if @pc != Job.COMPLETED %>
      <button class='btn btn-primary' id='advance-button' disabled>NEXT</button>
      <button class='btn'             id='note-button'>NOTE</button>
    <% end %>

  </div>

</div>

<script>

  <% if @job %>
    document.getElementById('info-area').innerHTML = '<%= @job.path %>';
  <% end %>

  function fix_height() {
    document.getElementById('interpreter').style.height = window.innerHeight - 120 + 'px';
  }

  fix_height();
  window.onresize = fix_height;

  nb = document.getElementById('note-button');

  if ( nb ) {

    nb.addEventListener('click', function() {

      var note = document.getElementById('note');

      if ( note.style.display == 'block' ) {
         note.style.display = 'none';
      } else {
         note.style.display = 'block';
      }

    } );

  }

  advance_url = function() {
    url = '/interpreter/advance?job=<%= @job.id %>';
    var note = document.getElementById('note-textarea');
    if ( note.value ) {
      url += '&lognote=' + note.value;
    }
    return url;
  }

  window.history.replaceState ( null, 'bioturk interpreter', 'current?job=<%= @job.id %>' );

  <% @instruction.console_messages.each do |m| %>
    console.log ( "PDL:" + '<%= m.html_safe %>' );
  <% end %>

</script>
