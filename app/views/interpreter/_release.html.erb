<h1>Release <%= @instruction.object_list.length %> Objects</h1>

<% i = 0 %>
<% next_check_list = [] %>

<% @instruction.object_list.each do |pi| %>

  <% nm       = pi[:object][:name]
     loc      = pi[:item][:location]
     method   = pi[:object][:release_description]
     quantity = pi[:quantity] %>

  <% case pi[:object][:release_method]

     when 'return' %>
      <h4><input type='checkbox' id='<%=i %>-returned' onchange='update_next_button(<%=i %>)'></input>
          Please return <%= pluralize(quantity,nm) %>.</h4>
      <p><%= method %></p>
      <% next_check_list.push(i) %>

  <% when 'dispose' %>
      <h4><input type='checkbox' id='<%=i %>-returned' onchange='update_next_button(<%=i %>)'></input> 
          Please dispose of <%= pluralize(quantity,nm) %>.</h4>
      <p><%= method %></p>
      <% next_check_list.push(i) %>

  <% when 'query' %>
      <h4>Return or dispose <%= pluralize(quantity,nm) %>?</h4>
      <p><%= method %></p>
      <div class="yesorno">
        <label class="radio inline">
          <input type="radio" id='<%=i %>-return-yes' checked name='<%=i %>-yn'>Return
        </label>
        <label class="radio inline">
          <input type="radio" id='<%=i %>-return-no' name='<%=i %>-yn'>Dispose
        </label>
      </div>

  <br />

  <% end %>

  <% i += 1 %>

<% end %>

<script>

  function update_next_button(i) {
    list = <%= next_check_list %>;
    show=true;
    for ( i=0; i<list.length; i++ ) {
      show = show && ( document.getElementById(list[i]+'-returned').checked );
    }
    if ( show ) {
      document.getElementById('advance-button').disabled = false;
    } else {
      document.getElementById('advance-button').disabled = true;
    }
  }

  window.onload = function() {

    <% if next_check_list.empty? %>
      document.getElementById('advance-button').disabled = false;
    <% else %>
      document.getElementById('advance-button').disabled = true;
    <% end %>

    document.getElementById('advance-button').addEventListener('click', function() {

      var i = 0;
      var q = '';

      <% @instruction.object_list.each do |pi| %>

        <% id = pi[:object][:id] %>

        <% if pi[:object][:release_method] == 'query' %>
          if ( document.getElementById(i+'-return-yes').checked ) {
            m = 'return';
          } else {
            m = 'dispose';
          }
        <% else %>
          m = '<%= pi[:object][:release_method] %>';
        <% end %>

        q += "&method_" + i + '=' + m;
        i += 1;

      <% end %>

      window.location = advance_url() + q;

    } );
  }
</script>

