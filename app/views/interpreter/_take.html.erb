<%
  name = @instruction.object_type
  object = @instruction.object
  num = @instruction.quantity
%>

<h1>You will need 
  <%= num %> 
  <%= name.pluralize(num) %>.</h1>

<div class='row-fluid'>

  <div class="span3 object-image">
    <%= image_tag object.image.url(:medium) %>
  </div>

  <div class="span9 object-image">
    <h4>Choose <%= num %> <%= "item".pluralize(num) %>:</h4>
    <ul>
      <% object.items.each do |i| %>
        <li>
          <%= i.location %>
          <input name='<%= i.id %>' class="small-input" type="number" value="0" onchange='update_total(<%= i.id %>,<%= i.quantity - i.inuse %>)'>
          of <%= i.quantity - i.inuse %> available.
        </li>  
      <% end %>
      <li>Total: <span id='total'>0</span> of <%= num %></li>
    </ul>
    <p>Choose location(s), place the object(s) at your station, and click next.</p>
  </div>

</div>

<script>

  function update_total(index,available) {

    total = 0;

    items = document.getElementsByClassName('small-input');
    for(i=0; i<items.length; i++) {
      if ( parseInt(items[i].value) < 0 ) {
        items[i].value = 0;
      }
      if ( items[i].name == index && parseInt(items[i].value) > available ) {
        items[i].value = available;
      }
      total += parseInt(items[i].value);
    }

    el = document.getElementById('total');
    el.innerHTML = total;

    if ( total == <%= num %> ) {
      document.getElementById('advance-button').disabled = false;
    } else {
      document.getElementById('advance-button').disabled = true;
    }

  }

  window.onload = function() {
    document.getElementById('advance-button').addEventListener('click', function() {
      query="";
      items = document.getElementsByClassName('small-input');
      for(i=0; i<items.length; i++) {
        query += "&i" + i + "=" + items[i].name + "&q" + i + "=" + items[i].value;
      }
      window.location = advance_url() + query;
    } );
  }

</script>
